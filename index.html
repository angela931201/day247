<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ç¦®ç‰©èˆ‡é¤å»³æ¨è–¦å°è©±</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@600&display=swap');
    body {
      font-family: 'Baloo 2', 'Microsoft JhengHei', cursive, sans-serif;
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 520px;
      margin: 48px auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 24px;
      border: 1px solid #ffcc80;
    }
    h1 {
      text-align: center;
      color: #ef6c00;
      font-size: 2rem;
      margin-bottom: 16px;
    }
    #chat {
      height: 350px;
      overflow-y: auto;
      border: 1px solid #ffb74d;
      border-radius: 8px;
      padding: 16px;
      background: #fff8e1;
      margin-bottom: 16px;
    }
    .msg {
      margin: 12px 0;
    }
    .user {
      color: #ef6c00;
      font-weight: bold;
      background: #ffe0b2;
      border-radius: 12px 12px 12px 0;
      display: inline-block;
      padding: 8px 12px;
    }
    .ai {
      color: #ffffff;
      font-weight: bold;
      background: #ffa726;
      border-radius: 12px 12px 0 12px;
      display: inline-block;
      padding: 8px 12px;
    }
    #inputArea {
      display: flex;
      gap: 8px;
    }
    #userInput {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ffcc80;
      font-size: 1rem;
    }
    #apiKeyInput {
      border-radius: 8px;
      border: 1px solid #ffcc80;
      padding: 8px;
      color: #ef6c00;
    }
    #saveKeyBtn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #ffa726;
      color: #fff;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI ç¦®ç‰©èˆ‡é¤å»³æ¨è–¦</h1>
    <div style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
      <label for="apiKeyInput" style="color:#ef6c00;">Google API é‡‘é‘°:</label>
      <input type="password" id="apiKeyInput" placeholder="è«‹è¼¸å…¥ API é‡‘é‘°">
      <button id="saveKeyBtn">å„²å­˜é‡‘é‘°</button>
    </div>

    <div id="chat"></div>

    <div id="inputArea">
      <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥ä½ çš„éœ€æ±‚...">
      <select id="topicSelect" style="border-radius:8px;padding:8px;font-size:1rem;">
        <option value="gift">ğŸ é€ç¦®æ¨è–¦</option>
        <option value="restaurant">ğŸ´ é¤å»³æ¨è–¦</option>
      </select>
    </div>
    <form id="addRecordForm" style="margin-top:16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:#fffde7;padding:12px 8px 8px 8px;border-radius:10px;">
      <input type="text" id="addName" placeholder="å§“å" required style="flex:1;min-width:80px;padding:6px;border-radius:6px;border:1px solid #ffcc80;">
      <input type="date" id="addDate" required style="flex:1;min-width:120px;padding:6px;border-radius:6px;border:1px solid #ffcc80;">
      <input type="text" id="addGift" placeholder="ç¦®ç‰©" required style="flex:1;min-width:80px;padding:6px;border-radius:6px;border:1px solid #ffcc80;">
      <input type="text" id="addRestaurant" placeholder="é¤å»³" required style="flex:1;min-width:100px;padding:6px;border-radius:6px;border:1px solid #ffcc80;">
      <button type="submit" style="padding:6px 18px;border:none;border-radius:6px;background:#ffa726;color:#fff;font-weight:bold;">æ–°å¢ç´€éŒ„</button>
    </form>
    <div id="history" style="margin-top:16px;"></div>
  </div>

  <script>
    let API_KEY = '';
    let API_URL = '';
    const chat = document.getElementById('chat');
    const userInput = document.getElementById('userInput');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveKeyBtn = document.getElementById('saveKeyBtn');

    function appendMsg(sender, text) {
      const div = document.createElement('div');
      div.className = 'msg';
      div.innerHTML = `<span class="${sender}">${sender === 'user' ? 'ä½ ' : 'AI'}ï¼š</span> ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setApiKey(key) {
      API_KEY = key;
      // ä½¿ç”¨æ–°ç‰ˆ Gemini 1.5 Flash API è·¯å¾‘
      API_URL = 'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=' + API_KEY;
      localStorage.setItem('gemini_api_key', key);
      apiKeyInput.value = key;
    }

    saveKeyBtn.onclick = () => {
      const key = apiKeyInput.value.trim();
      if (key) {
        setApiKey(key);
        appendMsg('ai', 'API é‡‘é‘°å·²å„²å­˜ï¼Œè«‹é–‹å§‹æå•ï¼');
      }
    };

    apiKeyInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') saveKeyBtn.click();
    });

    window.onload = () => {
      // è‡ªå‹•å¡«å…¥ API é‡‘é‘°
      const defaultKey = 'AIzaSyBK933R0dHt8i-NjrRRjKBwWuwIKYICVDs';
      let saved = localStorage.getItem('gemini_api_key');
      if (!saved) {
        setApiKey(defaultKey);
      } else {
        setApiKey(saved);
      }
      loadHistory(); // âœ… è¼‰å…¥ç”Ÿæ—¥ç¦®ç‰©ç´€éŒ„
    };

    async function askAI(question) {
      if (!API_KEY) {
        appendMsg('ai', 'è«‹å…ˆè¼¸å…¥ API é‡‘é‘°');
        return;
      }

      const topic = document.getElementById('topicSelect').value;
      let sysPrompt = '';
      if (topic === 'gift') {
        sysPrompt = 'ä½ æ˜¯ä¸€å€‹é€ç¦®é¡§å•ï¼Œè«‹ä¾æ“šä½¿ç”¨è€…æä¾›çš„æƒ…å¢ƒï¼ˆå°è±¡ã€èˆˆè¶£ã€å ´åˆç­‰ï¼‰æ¨è–¦é©åˆçš„ç¦®ç‰©ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚å•é¡Œï¼š';
      } else if (topic === 'restaurant') {
        sysPrompt = 'ä½ æ˜¯ä¸€ä½ç¾é£Ÿæ¨è–¦å°ˆå®¶ï¼Œè«‹æ ¹æ“šä½¿ç”¨è€…çš„åœ°é»ã€åå¥½èˆ‡å ´åˆï¼Œæ¨è–¦é©åˆçš„é¤å»³ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ã€‚å•é¡Œï¼š';
      }

      appendMsg('user', question);
      userInput.value = '';
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: sysPrompt + question }] }]
          })
        });

        const data = await res.json();
        console.log('Gemini API å›å‚³ï¼š', data);
        let aiText = 'ç„¡æ³•å–å¾—å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦';
        if (data.candidates && data.candidates[0]?.content?.parts) {
          aiText = data.candidates[0].content.parts.map(p => p.text).join('');
        } else if (data.error && data.error.message) {
          aiText = 'API éŒ¯èª¤ï¼š' + data.error.message;
        }
        appendMsg('ai', aiText);
      } catch (e) {
        console.error('API è«‹æ±‚å¤±æ•—', e);
        appendMsg('ai', 'è«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ– API é‡‘é‘°æ˜¯å¦æ­£ç¢º');
      }
    }

    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const q = userInput.value.trim();
        if (q) askAI(q);
      }
    });

    // èªéŸ³è¼¸å…¥
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'zh-TW';

    const voiceButton = document.createElement('button');
    voiceButton.textContent = 'ğŸ¤ èªéŸ³è¼¸å…¥';
    voiceButton.style = 'padding: 10px 22px; border: none; border-radius: 8px; background: #ffa726; color: #fff; font-size: 1rem; font-weight: bold; cursor: pointer; margin-left: 8px;';
    voiceButton.onclick = () => recognition.start();

    recognition.onresult = (event) => {
      if (event.results[0].isFinal) {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        askAI(transcript);
      }
    };

    recognition.onerror = (event) => {
      appendMsg('ai', 'èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡');
    };

    document.getElementById('inputArea').appendChild(voiceButton);

    appendMsg('ai', 'æ‚¨å¥½ï¼è«‹è¼¸å…¥æˆ–èªéŸ³è©¢å•è¦æ¨è–¦çš„ç¦®ç‰©æˆ–é¤å»³ ğŸ±ğŸ');
  // æ­·å²ç´€éŒ„è¼‰å…¥èˆ‡æ’å…¥
  // æ–°å¢æ‰‹å‹•æ–°å¢ç´€éŒ„è¡¨å–®åŠŸèƒ½
  document.getElementById('addRecordForm').onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById('addName').value.trim();
    const date = document.getElementById('addDate').value;
    const gift = document.getElementById('addGift').value.trim();
    const restaurant = document.getElementById('addRestaurant').value.trim();
    if (!name || !date || !gift || !restaurant) return;
    const data = JSON.parse(localStorage.getItem('records') || '[]');
    data.push({ name, date, gift, restaurant });
    localStorage.setItem('records', JSON.stringify(data));
    this.reset();
    loadHistory();
  };
  function loadHistory() {
    const history = document.getElementById('history');
    // æ¸…é™¤æœ‰ undefined æ¬„ä½çš„ç´€éŒ„
    let data = JSON.parse(localStorage.getItem('records') || '[]');
    data = data.filter(r => r.name && r.date && r.gift && r.restaurant && r.name !== 'undefined' && r.date !== 'undefined' && r.gift !== 'undefined' && r.restaurant !== 'undefined');
    localStorage.setItem('records', JSON.stringify(data));

    if (data.length === 0) {
      history.innerHTML = "<p style='color:gray;'>å°šç„¡ç´€éŒ„</p>";
      return;
    }

    history.innerHTML = '<h3>ğŸ æ­·å²é€ç¦®ç´€éŒ„</h3>' + data.map(r =>
      `<div style='margin-bottom:8px;'><strong>${r.name}</strong>ï¼${r.date}ï¼${r.gift}ï¼${r.restaurant}<br>
      <button onclick="insertRecord('${r.name}', '${r.gift}', '${r.date}', '${r.restaurant}')">ä½¿ç”¨é€™ç­†ç´€éŒ„</button>
      <div style='font-size:0.95em;color:#6d4c41;margin-top:2px;'>ç”Ÿæ—¥ï¼š${r.date}ï½œç¦®ç‰©ï¼š${r.gift}ï½œé¤å»³ï¼š${r.restaurant}</div></div>`
    ).join('');

    // é¡¯ç¤ºä»Šæ—¥å£½æ˜Ÿ
    const today = new Date();
    const mmdd = ('0' + (today.getMonth() + 1)).slice(-2) + '/' + ('0' + today.getDate()).slice(-2);
    const birthdayList = data.filter(r => {
      // æ”¯æ´ yyyy-mm-dd æˆ– yyyy/mm/dd
      const d = r.date.replace(/-/g, '/');
      return d.slice(5) === mmdd;
    });
    let birthdayHtml = `<div id="today-birthday" style="margin-top:18px;padding:10px 12px;background:#fff3e0;border-radius:8px;border:1px solid #ffcc80;">
      <b>ğŸ‚ ä»Šæ—¥å£½æ˜Ÿï¼š</b>`;
    if (birthdayList.length > 0) {
      birthdayHtml += birthdayList.map(r => `<span style='color:#ef6c00;font-weight:bold;'>${r.name}</span>ï¼ˆ${r.date}ï¼‰`).join('ã€');
    } else {
      birthdayHtml += '<span style="color:gray;">ç„¡</span>';
    }
    birthdayHtml += '</div>';
    history.innerHTML += birthdayHtml;
  }

  window.insertRecord = function(name, gift, date, restaurant) {
    const question = `å¹«æˆ‘æ¨è–¦é€çµ¦${name}çš„æ–°ç¦®ç‰©ï¼Œå»å¹´é€çš„æ˜¯${gift}ï¼Œç”Ÿæ—¥æ˜¯${date}ï¼Œå»å¹´é¤å»³æ˜¯${restaurant}ï¼Œè«‹ä¸è¦é‡è¤‡ã€‚`;
    userInput.value = question;
    askAI(question);
  }

  // (å·²åˆä½µæ–¼ä¸Šæ–¹ window.onload)
  </script>
</body>
</html>
